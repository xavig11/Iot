<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Iot</title>
    <script src="jquery-3.6.0.js"></script>
	<script>

	window.onload = function () {
			document.getElementById("demo").innerHTML = "Hello We Had Loaded JavaScript!";
			$("#button1").on('click', readData);
			$("#button2").on('click', actualizarSalasInfo);

	}

	var registro = [];

	class Registro {
		constructor(tag, port, time){
				this.tag = tag;
				this.port = port;
				this.time = time;
		}

	}

	function checkRegistro(tag, port, time){
		return registro.some(function(item){
			t = parseInt(time);
				tt = parseInt(item.time);
				return item.tag == tag && tt+3000 > time;
		});
	}

	function readData() {

		let url1 = "http://192.168.2.106:3161/devices/AdvanReader-m4-150/inventory"
		let url2 = "http://localhost:3161/devices/simulator/inventory"
		$.get(url2, function (data, status) {

			var $xml = $(data);
			var $item = $xml.find("item");

			$item.each(function(){

				var tag = $(this).find('epc').text();
				var info = $(this).find('prop').text();

				info_split = info.split(",");
				p = info_split[3];
				port = p.charAt(p.length-1);
				t = info_split[0];
				time = t.split(":")[1];

				if(!checkRegistro(tag, port, time)){
					registro.unshift(new Registro(tag, port, time));
					console.log("tag: " + tag + " Port: "+ port + " Time: " + time);
					actualizarRegistro();
				}
				//$('<p>'+tag+'</p>').appendTo('#colTag');
				//$('<p>'+port+'</p>').appendTo('#colPort');
				//$('<p>'+time+'</p>').appendTo('#colTime');

				//moverItem(tag, port);

			});
		});
	}

	var timer = setInterval(readData ,1000);

	class Item {
	  constructor(uid, nombre, apellido1, apellido2, fechaNacimiento, dni, puertasAcceso, salaActual) {
	    this.uid = uid;
	    this.nombre = nombre;
			this.apellido1 = apellido1;
			this.apellido2 = apellido2;
			this.fechaNacimiento = fechaNacimiento;
			this.dni = dni;
			this.puertasAcceso = puertasAcceso;
	    this.salaActual = salaActual;
	  }
	}

	var items = new Map();

	items.set("000000000000000000000001", new Item("000000000000000000000001","item1",-1));
	items.set("000000000000000000000002", new Item("000000000000000000000003","item2",-1));
	items.set("000000000000000000000003", new Item("000000000000000000000003","item3",-1));
	items.set("000000000000000000000004", new Item("000000000000000000000004","item4",-1));

	class Sala {
		constructor(uid, nombre){
	      this.uid = uid;
	      this.nombre = nombre;
				this.nItems = 0;
		}
	}

	var salas = new Map();

	salas.set(1, new Sala(1,"sala1"));
	salas.set(2, new Sala(2,"sala2"));

	function itemsEnSala(sala){

		let text = ""
		items.forEach((item, i) => {
			if (item.salaActual == sala ){
				text += item.uid + "		" + item.nombre + "<br>";
			}
		});
		return text;
	}

	function moverItem(item, to){

		i = items.get(item)

		if (i != undefined){
			if (to >= 3 ){
					items.get(item).salaActual = 2;
			}
			if (to <= 2){
					items.get(item).salaActual = 1;
			}
			actualizarSalasInfo();
		}
	}

	function actualizarSalasInfo(){

		$("#colSala1").html(itemsEnSala(1));
		$("#colSala2").html(itemsEnSala(2));

	}

	function actualizarRegistro(){
		$("#colTag").html("Tag");
		$("#colPort").html("Port");
		$("#colTime").html("Time");
		registro.forEach((item, i) => {
			$('<p>'+item.tag+'</p>').appendTo('#colTag');
			$('<p>'+item.port+'</p>').appendTo('#colPort');
			var date = new Date(parseInt(item.time));
			var hours = date.getHours();
			var minutes = "0" + date.getMinutes();
			var seconds = "0" + date.getSeconds();
			var formatTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
			$('<p>'+formatTime+'</p>').appendTo('#colTime');
		});
	}


	</script>
	</head>
	<body>

    <h2 id="demo">No s'ha carregat el js</h2>
    <button id="button1">Click on me!!</button>
		<button id="button2">Actualizar salas</button>
		<h1 id="Title">Almacen </h2>

		<div class="container">

			<div class="row mb-6 align-items-start">
				<div id="colTag" class="col-md-3">
				  Tag ID
				</div>
				<div id="colPort" class="col-md-3">
				  Port
				</div>
				<div id="colTime" class="col-md-3">
					Time
				</div>

			<div class="row mb-6 align-items-start">
				<div id="colSala1" class="col-md-3">
				  Sala1
				</div>
				<div id="colSala2" class="col-md-3">
				  Sala2
				</div>
			</div>

		</div>
	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>
